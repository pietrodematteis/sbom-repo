name: Aggregate Organization SBOMs
on:
  workflow_dispatch: # Allows manual trigger

jobs:
  gather-sboms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Create Workspace
        run: mkdir -p ./all-sboms

      - name: Fetch SBOMs
        shell: bash
        run: |
          # 1. Get the top 100 most starred repos on GitHub
            repos=$(gh search repos "" --limit 100 --sort stars --order desc --json fullName --jq '.[].fullName')
            
            for repo_full_name in $repos; do
              # Sanitize name for folder (replace '/' with '-')
              folder_name=$(echo $repo_full_name | tr '/' '-')
              echo "Processing $repo_full_name..."
              mkdir -p "./all-sboms/$folder_name"
            
              # 2. Try to find SBOM in branch
              # Note: We use the full name here because they aren't in your org
              gh api repos/$repo_full_name/contents/bom.json > /dev/null 2>&1
              if [ $? -eq 0 ]; then
                gh repo view $repo_full_name --path bom.json > "./all-sboms/$folder_name/branch-bom.json"
              fi
            
              # 3. Try to find SBOM in latest Release Assets
              latest_release_assets=$(gh release view --repo $repo_full_name --json assets --jq '.assets[].name' 2>/dev/null || true)
              # ... (rest of the download logic remains the same)
            done
            
      - name: Zip and Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-sboms
          path: ./all-sboms/
          retention-days: 5
