name: Aggregate Organization SBOMs
on:
  workflow_dispatch: # Allows manual trigger

jobs:
  gather-sboms:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Create Workspace
        run: mkdir -p ./all-sboms

      - name: Fetch SBOMs
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. Get the top 100 most starred repos on GitHub
            repos=$(gh search repos "SBOM" --limit 100 --sort stars --order desc --json fullName --jq '.[].fullName')
            REGEX='(?i)(^|[-_.])(?:sbom|cyclonedx|spdx|bom).*?\\.(json|xml|cdx|spdx|bom)?$'
            
            for repo_full_name in $repos; do
              # Sanitize name for folder (replace '/' with '-')
              folder_name=$(echo "$repo_full_name" | tr '/' '-')
              echo "Processing $repo_full_name..."
              mkdir -p "./all-sboms/$folder_name"

              # Try to get latest release; skip if not found
              if ! gh api "/repos/$repo_full_name/releases/latest" \
                --jq ".assets[] | select(.name | test(\"$REGEX\")) | [.id, .name] | @tsv" \
                2>/dev/null | while IFS=$'\t' read -r asset_id asset_name; do
                  echo "Downloading $asset_name -> ./all-sboms/$folder_name/$asset_name"
                  gh api -H "Accept: application/octet-stream" \
                    "/repos/$repo_full_name/releases/assets/$asset_id" > "./all-sboms/$folder_name/$asset_name"
            		  
                done; then
                echo "No release or no matching assets for $repo_full_name, skipping."
               fi
            done
      - name: Zip and Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-sboms
          path: ./all-sboms/
          retention-days: 5
